<!DOCTYPE html>
<html>

<head>
  <base target="_top">

  <style>
    /* Основные цвета и размеры шрифтов */

    :root {

      --white-color: #FFFFFF;
      --light-grey-color: #E5E5E5;
      --lighter-grey-color: #DDDDDD;
      --grey-color: #595757;
      --dark-grey-color: #454343;
      --darker-grey-color: #3B3939;

      --h1-font-size: 16px;
      --typesetting-font-size: 14px;
    }


    /* Заголовок */

    .title {
      font: 600 var(--h1-font-size) Arial, sans-serif;
      color: var(--dark-grey-color);
    }


    /* Форма */

    .form {
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 32px;
      border-radius: 26px;
      padding: 0;
      background-color: var(--white-color);
    }

    .form__title {
      margin: 0;
    }


    /* Содержимое */

    .content {
      display: flex;
      flex-direction: column;
      flex-wrap: wrap;
      align-content: space-between;
      gap: 24px;
      height: 452px;
    }


    /* Дата инвойса */

    .content__calculation {
      margin-top: auto;
    }


    /* Контрагет */

    .counterparty {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 372px;
    }


    /* Дополнение */

    .addition {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 0;
      padding-left: 10px;
    }

    .term {
      width: 121px;
      font: 400 var(--typesetting-font-size)/1.13 'Arial', sans-serif;
      color: var(--grey-color);
    }

    .details {
      width: 230px;
      margin: 0;
      font: 400 var(--typesetting-font-size)/1.13 'Arial', sans-serif;
      color: var(--grey-color);
      text-align: left;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow-x: hidden;
    }

    .details--display-none {
      display: none;
    }


    /* Секция с продуктами */

    .product-area {
      width: 725px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }


    /* Список продуктов */

    .product-list {
      display: flex;
      flex-direction: column;
      gap: 24px;
      max-height: 205px;
      overflow-y: scroll;
    }

    .product-list--empty:has(template:only-child) {
      display: none;
    }


    /* Продукт */

    .product {
      display: flex;
      gap: 24px;
    }


    /* Калькулятор */

    .calculation {
      display: flex;
      justify-content: right;
      gap: 24px;
      overflow: hidden;
    }


    /* Кнопка */

    .button {
      display: flex;
      justify-content: center;
      align-items: center;
      border-style: none;
      border-radius: 6px;
      height: 24px;
      padding: 2px 12px;
      color: var(--white-color);
      font: 500 var(--typesetting-font-size) 'Arial', sans-serif;
    }


    .button--grey {
      background-color: var(--grey-color);
    }

    .button--light-grey {
      background-color: var(--light-grey-color);
    }

    .button--font-dark-grey {
      color: var(--dark-grey-color);
    }

    .button--waiting {
      background-color: var(--darker-grey-color);
      cursor: pointer;
    }

    .button--light-grey:hover {
      background-color: var(--lighter-grey-color);
      cursor: pointer;
    }

    .button--grey:hover {
      background-color: var(--dark-grey-color);
      cursor: pointer;
    }


    /* Заголовок поля ввода */

    .label {
      display: flex;
      flex-direction: column;
      gap: 12px;
      font: 600 var(--typesetting-font-size) 'Arial', sans-serif;
      color: var(--dark-grey-color);
    }

    .lable--center {
      align-items: center;
    }


    /* Поле ввода */

    .input {
      box-sizing: border-box;
      height: 24px;
      border: 1px solid var(--dark-grey-color);
      border-radius: 6px;
      padding: 0px 8px;
      font: 400 var(--typesetting-font-size) 'Arial', sans-serif;
      color: var(--dark-grey-color);
    }


    .input--width-extra-large {
      width: 238px;
    }

    .input--width-large {
      width: 112px;
    }

    .input--width-medium {
      width: 82px;
    }


    .input--width-small {
      width: 56px;
    }

    .input--appearance-none {
      appearance: none;
    }

    .input--appearance-none::-webkit-outer-spin-button,
    .input--appearance-none::-webkit-inner-spin-button {
      appearance: none;
    }

    .input--overflow-hidden {
      overflow: hidden;
    }

    .input--background-corner-drawn {
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23595757" width="16" height="16"><path d="M7 10l5 5 5-5H7z"/></svg>') no-repeat;
      background-position: calc(100% - 4px) center;
      background-size: 18px;
    }

    .input--cut-down {
      padding-right: 16px;
      text-overflow: ellipsis;
    }


    /* Поле вывода */

    .output {
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 74px;
      height: 24px;
      padding: 0px 8px;
      font: 600 var(--typesetting-font-size) 'Arial', sans-serif;
      color: var(--grey-color);
      text-align: center;
    }
  </style>
</head>

<body>

  <form class="form" name="invoice">


    <!-- Заголовок инвойса -->

    <h1 class="title form__title" data-element-type="invoice-number">Invoice №</h1>


    <!-- Общий раздел дл ввода данных -->

    <section class="content">


      <!-- Подраздел с вводом даты создания/обновления инвойса (по умолчанию текущая) -->

      <label class="label">
				Date (Сurrent by default)*
				<input type="date" class="input input--width-large" data-element-type="invoice-date">
			</label>


      <!-- Подраздел с инофрмацией о подрядчике -->

      <section class="counterparty">

        <label class="label">
					From (Business Name)*
					<select class="input input--appearance-none input--background-corner-drawn input--overflow-hidden"
						data-element-type="contractor-name" required>
              <option></option>
					</select>
				</label>

        <dl class="addition">

					<dt class="term">Full Address:</dt>
					<dd class="details" data-element-type="contractor-address">➥</dd>

					<dt class="term">Phone Number:</dt>
					<dd class="details" data-element-type="contractor-phone">➥</dd>

					<dt class="term">Email:</dt>
					<dd class="details" data-element-type="contractor-email">➥</dd>

					<dt class="term">Bank Name:</dt>
					<dd class="details" data-element-type="contractor-bank-name">➥</dd>

					<dt class="term">Sort Number:</dt>
					<dd class="details" data-element-type="contractor-sort-number">➥</dd>

					<dt class="term">Account Number:</dt>
					<dd class="details" data-element-type="contractor-account-number">➥</dd>

					<dt class="term">Alternative Method:</dt>
					<dd class="details" data-element-type="contractor-alternative-method">➥</dd>

        </dl>

      </section>


      <!-- Подраздел с информацией о заказчике -->

      <section class="counterparty">

        <label class="label">
					To (Full Name / Business Name)*
					<select
						class="input input--appearance-none input--background-corner-drawn input--overflow-hidden input--cut-down"
						data-element-type="client-name" required>

            <option></option>

					</select>
				</label>

        <dl class="addition">

					<dt class="term">Full Address:</dt>
					<dd class="details" data-element-type="client-address">➥</dd>

					<dt class="term">Phone Number:</dt>
					<dd class="details" data-element-type="client-phone">➥</dd>

					<dt class="term">Email:</dt>
					<dd class="details" data-element-type="client-email">➥</dd>

        </dl>

      </section>


      <!-- Секция в которой генерируются позиции продуктов -->

      <section class="product-area">


        <!-- Секция со списком продуктов  -->

        <section class="product-list product-list--empty" data-element-type="product-list">


          <!-- Секция с продуктом, используемая как шаблон из которого она создается при первой загрузки формы и в последующем при нажатии на кнопку "Create Product" -->

          <template data-element-type="product-template">


            <section class="product" data-element-type="product">

              <label class="label lable--center">
                  Product*

                  <select class="input input--appearance-none input--background-corner-drawn input--width-extra-large input--overflow-hidden input--cut-down" data-element-type="product-name">
              
                      <option></option>

                  </select>

                </label>

              <label class="label lable--center">
                  Date
                  <input type="date" class="input input--width-large" 
                  data-element-type="product-date">
                </label>

              <label class="label lable--center">
                  QTO
                  <input type="number" min="0" step="1" placeholder="0" class="input input--appearance-none input--width-small"
                    data-element-type="product-quantity">
                </label>

              <label class="label lable--center">
                  Price*
                  <input type="number" min="0" step="any" placeholder="0.00" class="input input--appearance-none input--width-medium"
                    data-element-type="product-price">
                </label>

              <label class="label lable--center">
                  Total
                  <output class="output" data-element-type="product-total">0</output>
                </label>

              <label class="label lable--center">
                  Delete
                  <button type="button" class="button button--light-grey button--font-dark-grey"
                    data-element-type="product-delete-button">
                    ⌫
                  </button>
                </label>
            </section>

          </template>

        </section>


        <!-- Кнопка для cоздания новой продуктов -->

        <button type="button" class="button button--light-grey button--font-dark-grey"
					data-element-type="product-adding-button">
					Create Product
				</button>

      </section>


      <!-- Подраздел с вычислением итогов по услугам -->

      <section class="calculation content__calculation">

        <label class="label lable--center">
					Subtotal
					<output class="output subtotal--input" data-element-type="subtotal">0</output>
				</label>

        <label class="label lable--center">
					Discount (%)
					<input type="number" min="0" step="any" placeholder="0.00" class="input input--appearance-none input--width-medium" data-element-type="discount">
				</label>

        <label class="label lable--center">
					VAT (%)
					<input type="number" min="0" step="any" placeholder="0.00" class="input input--appearance-none input--width-medium" data-element-type="vat">
				</label>

        <label class="label lable--center">
					Total
					<output class="output" data-element-type="total">0</output>
				</label>

      </section>


      <!-- Комментарий к созданным услугам -->

      <label class="label">Comment
				<input type="text" class="input" data-element-type="comment">
			</label>


    </section>


    <!-- Кнопка для запуска обработчки инвойса  -->

    <button type="submit" class="button button--grey" data-element-type="submit-button">Create Invoice</button>

  </form>

  <script>


    // Получаем данные сформированные на строне app script:

    const {
      invoiceNumber, 
      isNewInvoice, 
      contractorSheetObject, 
      clientSheetObject, 
      productSheetObject, 
      invoiceRegistryColumnNamesWithIndexes, 
      productRegistryColumnNamesWithIndexes
    } = JSON.parse( /*<?= externalDataObject ?>*/ );


    // Устанавливаем дату создания инвойса по умолчанию в форме:

		document.querySelector('input[data-element-type="invoice-date"]').value = new Date().toISOString().split('T')[0];


    // Устанавливаем номер инвойса в заголовке формы и текст показывающий пользователю новый это инвойс или в данный момент редактируемый:

    const invoiceHeaderElement = document.querySelector('[data-element-type="invoice-number"]')
    invoiceHeaderElement.innerText = `${invoiceHeaderElement.textContent} ${invoiceNumber} (${isNewInvoice == true ? 'new' : 'being edited'})`;


    // Наполняем выпадающих список элементов для подрядчика и соответствующие дополнительные поля с описанием:

    const contractorSheetArray = contractorSheetObject.contractorSheetArray;
    const contractorColumnNamesWithIndexes = contractorSheetObject.contractorColumnNamesWithIndexes;

    const contractorNameElement = document.querySelector('[data-element-type="contractor-name"]');
    
    contractorSheetArray.forEach(contractorRowArray => {
      const option = document.createElement("option");
      option.text = contractorRowArray[contractorColumnNamesWithIndexes.companieNameIndex];
      contractorNameElement.appendChild(option);
    })

    addDescriptionElement('[data-element-type="contractor-address"]', contractorSheetArray, contractorColumnNamesWithIndexes.addressIndex, 'contractor-address');
    addDescriptionElement('[data-element-type="contractor-phone"]', contractorSheetArray, contractorColumnNamesWithIndexes.phoneNumberIndex, 'contractor-phone');
    addDescriptionElement('[data-element-type="contractor-email"]', contractorSheetArray, contractorColumnNamesWithIndexes.emailIndex, 'contractor-email');
    addDescriptionElement('[data-element-type="contractor-bank-name"]', contractorSheetArray, contractorColumnNamesWithIndexes.bankNameIndex, 'contractor-bank-name');
    addDescriptionElement('[data-element-type="contractor-sort-number"]', contractorSheetArray, contractorColumnNamesWithIndexes.sortNumberIndex, 'contractor-sort-number');
    addDescriptionElement('[data-element-type="contractor-account-number"]', contractorSheetArray, contractorColumnNamesWithIndexes.accountNumberIndex, 'contractor-account-number');
    addDescriptionElement('[data-element-type="contractor-alternative-method"]', contractorSheetArray, contractorColumnNamesWithIndexes.alternativeMethodIndex, 'contractor-alternative-method');


    // Наполняем выпадающих список элементов для клиента и дополнительные пол] с описанием:

    const clientSheetArray = clientSheetObject.clientSheetArray;
    const clientColumnNamesWithIndexes = clientSheetObject.clientColumnNamesWithIndexes;

    const clientNameElement = document.querySelector('[data-element-type="client-name"]');
    
    clientSheetArray.forEach(clientRowArray => {
      const option = document.createElement("option");
      option.text = clientRowArray[clientColumnNamesWithIndexes.clientNameIndex];
      clientNameElement.appendChild(option);
    })

    addDescriptionElement('[data-element-type="client-address"]', clientSheetArray, clientColumnNamesWithIndexes.addressIndex, 'client-address');
    addDescriptionElement('[data-element-type="client-phone"]', clientSheetArray, clientColumnNamesWithIndexes.phoneNumberIndex, 'client-phone');
    addDescriptionElement('[data-element-type="client-email"]', clientSheetArray, clientColumnNamesWithIndexes.emailIndex, 'client-email');


		// Устанавливаем секцию с первым продуктом из шаблона для полсдеющего заполнения пользователем:

		const productElementTepmplate = document.querySelector('[data-element-type="product-template"]');
    const productSheetArray = productSheetObject.productSheetArray;
    const productColumnNamesWithIndexes = productSheetObject.productColumnNamesWithIndexes;

    const productNameElement = productElementTepmplate.content.querySelector('[data-element-type="product-name"]');
    productSheetArray.forEach(productRowArray => {
      const option = document.createElement("option");
      option.text = productRowArray[productColumnNamesWithIndexes.productNameIndex];
      productNameElement.appendChild(option);
    });
		
    const productElementFragment = productElementTepmplate.content.cloneNode(true);
		const productElement = productElementFragment.firstElementChild;
		const productElementList = document.querySelector('[data-element-type="product-list"]')

		productElementList.appendChild(productElement);
    

		// Подписываем корневой элемент на основные события формы для обработки соответсвующих событий внутри формы:

		['click', 'input', 'change'].forEach(eventType => document.forms.invoice.addEventListener(eventType, handle));


		// Создаем функцию, которая будет вызываться на корневом элементе, обрабатывая все события потомков корневого элемента:

		function handle(event) {


			// Определяем тип события и название компанента, на котором вызвано это событие:

			const eventType = event.type;
			const elementType = event.target.dataset.elementType;


			// Обрабытываем все входящие события на компонентах, меняя в ответ соответствующие им исходящие компоненты: 

			switch (true) {


				// Обрабатываем нажатие кнопки "Create Product":

				case (eventType == 'click' && elementType == 'product-adding-button'): {


					// Создаем новую элемент отдельного продукта из шаблона в html:

					const productElementFragment = productElementTepmplate.content.cloneNode(true);
					const productElement = productElementFragment.firstElementChild;
					productElementList.appendChild(productElement);


					// Проматываем созданный продукт вниз, чтобы его отобразаить, в случае переполнения списка продуктов:

					productElement.scrollIntoView({ behavior: 'smooth', block: 'end' });

					break;
				}


				// Обрабатываем нажатие кнопки в поле "Del" (уникальный компонент):

				case (eventType == 'click' && elementType == 'product-delete-button'): {


					// Удаляем позицию продукта на которой была нажата кнопка в поле "Del":

					event.target.closest('[data-element-type="product"]').remove();


					// Пересчитываем общую сумму позиции для всех элементов в поле "Subtotal":

					document.querySelector('[data-element-type="subtotal"]').textContent = getSubtotat().toFixed(2);


					// Устаналвивае общую сумму позиции для всех элементов в одноименное поле "Total":

					const discount = document.querySelector('[data-element-type="discount"]').value;
					const vat = document.querySelector('[data-element-type="vat"]').value;
					const subtotal = getSubtotat();

					document.querySelector('[data-element-type="total"]').textContent = getAllProductTotal(discount, vat, subtotal).toFixed(2);

					break;
				}


				// Обрабатываем ввод для поля "QTO" (динамически созданной компонент): 

				case (eventType == 'input' && elementType == 'product-quantity'): {


					// Устаналвивае сумму позиции для одного элемента в поле "Total":

					const productQuantityElement = event.target;
					const productElement = productQuantityElement.closest('[data-element-type="product"]')
					productElement.querySelector('[data-element-type="product-total"]').textContent = getOneProductTotal(productElement, productQuantityElement).toFixed(2);


					// Устаналвивае общую сумму позиции для всех элементов в поле "Subtotal":

					const subtotal = getSubtotat();
					document.querySelector('[data-element-type="subtotal"]').textContent = subtotal.toFixed(2);


					// Устаналвивае общую сумму позиции для всех элементов в одноименное поле "Total":

					const discount = document.querySelector('[data-element-type="discount"]').value;
					const vat = document.querySelector('[data-element-type="vat"]').value;

					document.querySelector('[data-element-type="total"]').textContent = getAllProductTotal(discount, vat, subtotal).toFixed(2);

					break;
				}


				// Обрабатываем ввод для поля "Price" (динамически созданной компонент): 

				case (eventType == 'input' && elementType == 'product-price'): {


					// Устаналвивае сумму позиции для одного элемента в поле "Total":

					const productPriceElement = event.target;
					const productElement = productPriceElement.closest('[data-element-type="product"]')
					productElement.querySelector('[data-element-type="product-total"]').textContent = getOneProductTotal(productElement, productPriceElement).toFixed(2);


					// Устаналвивае общую сумму позиции для всех элементов в поле "Subtotal":

					const subtotal = getSubtotat();
					document.querySelector('[data-element-type="subtotal"]').textContent = subtotal.toFixed(2);


					// Устаналвивае общую сумму позиции для всех элементов в одноименное поле "Total":

					const discount = document.querySelector('[data-element-type="discount"]').value;
					const vat = document.querySelector('[data-element-type="vat"]').value;

					document.querySelector('[data-element-type="total"]').textContent = getAllProductTotal(discount, vat, subtotal).toFixed(2);

					break;
				}


				// Обрабатываем ввод поля "Discount" (уникальный компонент):

				case (eventType == 'input' && elementType == 'discount'): {


					// Получаем процент дисконта общий для всех продуктов:

					const discount = event.target.value;


					// Получаем общую сумму позиции для всех элементов в поле "Subtotal":

					const subtotal = getSubtotat();


					// Получаем процент VAT:

					const vat = document.querySelector('[data-element-type="vat"]').value;


					// Устаналвивае общую сумму позиции для всех элементов в одноименное поле "Total" с учетом дисконта и ват:

					document.querySelector('[data-element-type="total"]').textContent = getAllProductTotal(discount, vat, subtotal).toFixed(2);

					break;
				}


				// Обрабатываем ввод поля "VAT" (уникальный компонент):

				case (eventType == 'input' && elementType == 'vat'): {


					// Получаем  процент VAT общй для всех продуктов::

					const vat = event.target.value;


					// Получаем общую сумму позиции для всех элементов в поле "Subtotal":

					const subtotal = getSubtotat();


					// Получаем процент дискнота:

					const discount = document.querySelector('[data-element-type="discount"]').value;


					// Устаналвивае общую сумму позиции для всех элементов в одноименное поле "Total" с учетом дисконта и ват:

					document.querySelector('[data-element-type="total"]').textContent = getAllProductTotal(discount, vat, subtotal).toFixed(2);

					break;

				}


				// Обрабатываем выбор в выпадающем списке "From (Business Name)*"

				case (eventType == 'change' && elementType == 'contractor-name'): {


					// Получаем индекс выбранного "Поставщика":

					const selectedIndex = event.target.selectedIndex;


					// Обновляем все значения дополнительных полей соответствующее выбранному поставщику:

					updateCounterpartyFileldValue('[data-element-type="contractor-address"]', selectedIndex);
					updateCounterpartyFileldValue('[data-element-type="contractor-phone"]', selectedIndex);
					updateCounterpartyFileldValue('[data-element-type="contractor-email"]', selectedIndex);
					updateCounterpartyFileldValue('[data-element-type="contractor-bank-name"]', selectedIndex);
					updateCounterpartyFileldValue('[data-element-type="contractor-sort-number"]', selectedIndex);
					updateCounterpartyFileldValue('[data-element-type="contractor-account-number"]', selectedIndex);
					updateCounterpartyFileldValue('[data-element-type="contractor-alternative-method"]', selectedIndex);

					break;
				}


        // Обрабатываем выбор в выпадающем списке "To (Full Name / Business Name)*"

				case (eventType == 'change' && elementType == 'client-name'): {


					// Получаем индекс выбранного "Клиента":

					const selectedIndex = event.target.selectedIndex;


					// Обновляем все значения дополнительных полей соответствующее выбранному поставщику:

					updateCounterpartyFileldValue('[data-element-type="client-address"]', selectedIndex);
					updateCounterpartyFileldValue('[data-element-type="client-phone"]', selectedIndex);
					updateCounterpartyFileldValue('[data-element-type="client-email"]', selectedIndex);


					break;
				}


				// Обрабатываем запуск отправки данных формы"

				case (eventType == 'click' && elementType == 'submit-button'): {

          
          // Собираем все даные с формы:

          const invoiceId = invoiceNumber;
          const invoiceDate = document.querySelector('[data-element-type="invoice-date"]').value;
          const contractorName = document.querySelector('[data-element-type="contractor-name"]').value;
          const clientName = document.querySelector('[data-element-type="client-name"]').value;
          const subtotal = document.querySelector('[data-element-type="subtotal"]').value;
          const discount = document.querySelector('[data-element-type="discount"]').value / 100;
          const vat = document.querySelector('[data-element-type="vat"]').value / 100;
          const total = document.querySelector('[data-element-type="total"]').value;
          const comment = document.querySelector('[data-element-type="comment"]').value;

          const productNameArray = Array.from(document.querySelectorAll('[data-element-type="product-name"]')).map(productNameElement => productNameElement.value);
          const productDateArray = Array.from(document.querySelectorAll('[data-element-type="product-date"]')).map(productNameElement => productNameElement.value);
          const producQuantityArray = Array.from(document.querySelectorAll('[data-element-type="product-quantity"]')).map(productNameElement => productNameElement.value);
          const productPriceArray = Array.from(document.querySelectorAll('[data-element-type="product-price"]')).map(productNameElement => productNameElement.value);
          const productTotalArray = Array.from(document.querySelectorAll('[data-element-type="product-total"]')).map(productNameElement => productNameElement.value);


          // Проверяем данные введенные пользователем в форму:

          if (contractorName == "") {
            alert('Please fill in the company name ( From (Business Name)* )!');
            return;
          }

          if (clientName == "") {
            alert('Please fill in the client name ( To (Full Name / Business Name)* )!');
            return;
          }

          if (productNameArray.every(productName => productName == '') && productPriceArray.every(productPrice => productPrice == '')) {
            alert('At least one product must be filled!');
            return;
          }

          if (productNameArray.length != new Set(productNameArray).size) {
            alert('There should not be identical product names!');
            return;
          }

          for (const productIndex in productNameArray) {
            if (productNameArray[productIndex] != '' && productPriceArray[productIndex] == '') {
              alert('There is a product position with an empty price field!');
              return;
            } else if (productNameArray[productIndex] == '' && productPriceArray[productIndex] != '') {
              alert('There is a price position with an empty product field!');
              return;
            }
          }


          // Подгатавливаем данные для вставки на соответсвующий лист: "INVOICE REGISTRY":

          const invoiceRegistryArray = [[]];

          invoiceRegistryArray[0][invoiceRegistryColumnNamesWithIndexes.idIndex] = invoiceId;
          invoiceRegistryArray[0][invoiceRegistryColumnNamesWithIndexes.dateIndex] = invoiceDate;
          invoiceRegistryArray[0][invoiceRegistryColumnNamesWithIndexes.statusIndex] = false;
          invoiceRegistryArray[0][invoiceRegistryColumnNamesWithIndexes.contractorNameIndex] = contractorName;
          invoiceRegistryArray[0][invoiceRegistryColumnNamesWithIndexes.clientNameIndex] = clientName;
          invoiceRegistryArray[0][invoiceRegistryColumnNamesWithIndexes.subtotalIndex] = subtotal;
          invoiceRegistryArray[0][invoiceRegistryColumnNamesWithIndexes.discountIndex] = discount;
          invoiceRegistryArray[0][invoiceRegistryColumnNamesWithIndexes.vatIndex] = vat;
          invoiceRegistryArray[0][invoiceRegistryColumnNamesWithIndexes.totalIndex] = total;
          invoiceRegistryArray[0][invoiceRegistryColumnNamesWithIndexes.commentIndex] = comment;


          // Подгатавливаем данные для вставки на соответсвующий лист "PRODUCT REGISTRY":

          const productRegistryArray = [];

          for (let i in productNameArray) {    
            
            const newRowArray = [];

            newRowArray[productRegistryColumnNamesWithIndexes.invoiceIdIndex] = invoiceId;
            newRowArray[productRegistryColumnNamesWithIndexes.productNameIndex] = productNameArray[i];
            newRowArray[productRegistryColumnNamesWithIndexes.dateIndex] = productDateArray[i];
            newRowArray[productRegistryColumnNamesWithIndexes.qtyIndex] = producQuantityArray[i] == '' ? 1 : producQuantityArray[i];
            newRowArray[productRegistryColumnNamesWithIndexes.priceIndex] = productPriceArray[i];
            newRowArray[productRegistryColumnNamesWithIndexes.totalIndex] = productTotalArray[i];

            if (productNameArray[i] && productPriceArray[i]) productRegistryArray.push(newRowArray);
          }


          // Собираем все в общий массив для отправки:
          
          const invoiceDataObject = {invoiceRegistryArray, productRegistryArray};


          // Устанавлива сообщение и стиль в кнопку, что бы сообщить пользователь не закрывать её пока идет создание нового инвойс и что она закроется сама:

          event.target.classList.add('button--waiting');
          event.target.innerText = `Please don't close me, I'm creating an invoice for you and close myself when it is ready!`;


          // В зависимости от цели вызова формы, запускаем соответсвующую функцию:

          if (isNewInvoice == true) {
            makeInvoice(invoiceDataObject);
          } else {
            editInvoice(invoiceDataObject);
          }

					break;
				}
			}
		}

		
		// Создаем функцию для подсчета прмежуточной сумммы для одного продукта:

		function getOneProductTotal(productElement, productContributeElement) {


			// Идентифицируем какой из двух элементов нам передан:

			const elementType = productContributeElement.dataset.elementType;


			// Получаем количество продукта:

			const productQuantity = elementType == 'product-quantity' ?
				productContributeElement.value :
				productElement.querySelector('[data-element-type="product-quantity"]').value;


			// Получаем стоимость продукта:

			const productPrice = elementType == 'product-price' ?
				productContributeElement.value :
				productElement.querySelector('[data-element-type="product-price"]').value;


			// Возвращаем результат с учетом того, что для количества по умолчанию единица, округлив его до двух знаков в виде строки:

			return ((productQuantity === '' ? 1 : productQuantity) * (productPrice === '' ? 0 : productPrice))

		}


		// Создаем функцию для подсчета промежуточной суммы по всем продуктам для поля "Subtotal":

		function getSubtotat() {

			const allProductElements = document.querySelectorAll('[data-element-type="product"]');
			const allProductElementArray = Array.from(allProductElements);
			const generalSubtotal = allProductElementArray.reduce((sum, productElement) => {


				// Получаем количество в рамках одного продуктов:

				const productQuantity = productElement.querySelector('[data-element-type="product-quantity"]').value;


				// Получаем стоимость в рамках одного продукта:

				const productPrice = productElement.querySelector('[data-element-type="product-price"]').value;


				// Возвращаем сумму:

				return sum + (productQuantity === '' ? 1 : productQuantity) * (productPrice === '' ? 0 : productPrice)

			}, 0)

			return generalSubtotal;
		}


		// Создаем функцию, которая считает общую сумму:

		function getAllProductTotal(discount, vat, subtotal) {
			return subtotal - subtotal * (discount / 100) + (subtotal - subtotal * (discount / 100)) * (vat / 100);
		}


		// Определяем функцию, которая скрывает предыдущие значение поля, выброннаго контрагента и устанавливаем новое:

		function updateCounterpartyFileldValue(counterpartySelectorName, selectedIndex) {

			Array.from(document.querySelectorAll(counterpartySelectorName)).forEach((element, index) => {

				// Скрываем текущий не скрытй элемент:

				if (element.offsetParent != null) element.style.display = 'none';


				// Делаем видимым новый элемент в соответсвии с выбраным именем контрагента:

				if (index == selectedIndex) {
          element.style.display = 'block'
          element.setAttribute('title', element.textContent);
        }

			})

		}


    // Заполняет жлементами описания контрагентов в соответствии с порядком в массиве на листах с подрядчиком и контрагентом:

    function addDescriptionElement(selector, sheetArray, cloumnIndex, elementType) {

      const startDescriptionElement = document.querySelector(`${selector}`);
      
      let nextDescriptionElement;

      sheetArray.forEach((sheetRowArray, index) => {
        const descriptionElement = document.createElement("dd");
        descriptionElement.classList.add("details")
        descriptionElement.classList.add("details--display-none")
        descriptionElement.textContent = sheetRowArray[cloumnIndex];
        descriptionElement.dataset.elementType = `${elementType}`;

        index == 0 ?
          startDescriptionElement.insertAdjacentElement('afterend', descriptionElement) :
          nextDescriptionElement.insertAdjacentElement('afterend', descriptionElement)

        nextDescriptionElement = descriptionElement;
      })

    }


    /*
     Запускает функцию генерирующую pdf файл инвойса в корневой папке "INVOICES" google drive, перенося предыдущий инвойс в подпапку "INVOICES/ARCHIVE", 
     сохраняя данные инвойса в соответсвующиъ реестах - листы "INVOICE REGISTRY" и "PRODUCT REGISTRY":
    */

    function makeInvoice(invoiceDataObject) {

      google
        .script
        .run
        .withFailureHandler(
          (error) => {
            google.script.host.close(); alert(`An error occurred while generating the invoice: "${error}", please try after some time!`)
          }
        ).withSuccessHandler(google.script.host.close)
          .makeInvoice(invoiceDataObject);

    }


    /*
     Запускает функцию генерирующую pdf файл обновленного инвойса в корневой папке "INVOICES" google drive, перенося предыдущий инвойс в подпапку "INVOICES/ARCHIVE", 
     обновляя данные инвойса в соответсвующих реестах - листы "INVOICE REGISTRY" и "PRODUCT REGISTRY":
    */

    function editInvoice(invoiceDataObject) {

      google
        .script
        .run
        .withFailureHandler(
          (error) => {
            google.script.host.close(); alert(`An error occurred while generating the invoice: "${error}", please try after some time!`)
          }
        ).withSuccessHandler(google.script.host.close)
          .editInvoice(invoiceDataObject);
    }

  </script>
</body>

</html>